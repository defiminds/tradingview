// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© c2V2ZW4K
//@version=5
strategy("Anchored VWAP Strategy for Bitcoin", overlay=true)
buy_only = input.bool(true, "Buy Only")
sell_only = input.bool(false, "Sell Only")
use_sma_entry = input.bool(true, "Use Simple Moving Average for Entry")
sma_entry_len = input.int(20, "SMA Entry Length", minval=1)
sma_entry = ta.sma(close, sma_entry_len)
til_len = input.int(10, "Tillson MA Length", minval=1)
wma1 = ta.wma(2*ta.wma(close, til_len/2)-ta.wma(close, til_len), math.round(math.sqrt(til_len)))
wma2 = ta.wma(2*ta.wma(close, til_len/2)-ta.wma(close, til_len), til_len)
tilson_ma = 0.7*wma1 + 0.3*wma2
long_condition = ta.crossover(close, tilson_ma)
short_condition = ta.crossunder(close, tilson_ma)
if (use_sma_entry)
    long_condition := long_condition and ta.crossover(close, sma_entry)
    short_condition := short_condition and ta.crossunder(close, sma_entry)
if (buy_only)
    strategy.entry("Buy", strategy.long, when=long_condition)
else if (sell_only)
    strategy.entry("Sell", strategy.short, when=short_condition)
else
    strategy.entry("Buy", strategy.long, when=long_condition)
    strategy.entry("Sell", strategy.short, when=short_condition)
if (strategy.position_size > 0 and ta.crossunder(close, tilson_ma))
    strategy.close("Buy")
if (strategy.position_size < 0 and ta.crossover(close, tilson_ma))
    strategy.close("Sell")
len = input.int(121, "Length", minval=1)
start = input.time(timestamp("01 Jan 2022 00:00"))
anchored_vwap = request.security(syminfo.tickerid, "D", ta.vwma(close, len), barmerge.gaps_off, barmerge.lookahead_on, start)
plot(anchored_vwap, "Anchored VWAP", color=color.red)
plot(tilson_ma, "Tillson MA", color=color.green)
